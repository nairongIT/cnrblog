{% extends 'base.html' %}

{% block title %}编辑文章{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{% static 'editor.md-1.5.0/css/editormd.min.css' %}">
    <style>
        .form-label { font-weight: 600; }
    </style>
{% endblock %}

{% block main %}
    <h1>编辑文章</h1>
    <hr>

    <form id="editForm" novalidate>
        {% csrf_token %}

        <div class="mb-4">
            <label for="title" class="form-label">标题</label>
            <input type="text" name="title" id="title" class="form-control" value="{{ article.title }}" required>
        </div>

        <div class="mb-4">
            <label class="form-label">标签</label>
            <div>
                {% for tag in tags %}
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="tag_{{ tag.id }}" name="tags" value="{{ tag.pk }}" {% if tag.id in selected_tag_ids %}checked{% endif %}>
                        <label class="form-check-label" for="tag_{{ tag.id }}">{{ tag.name }}</label>
                    </div>
                {% endfor %}
            </div>
        </div>

        <div class="mb-4">
            <label for="content" class="form-label">内容</label>
            <div class="mb-2">
                <button type="button" class="btn btn-outline-secondary btn-sm" id="uploadImageBtn">上传图片</button>
                <input type="file" id="imageFileInput" accept=".jpg,.jpeg,.png,.gif,.webp" style="display:none;">
            </div>
            <div id="editor-container">
                <textarea id="content" name="content" style="display:none;">{{ article.content }}</textarea>
            </div>
        </div>

        <button type="button" class="btn btn-primary" id="submitBtn">保存修改</button>
        <a href="/article/{{ article.id }}/" class="btn btn-outline-secondary">取消</a>
        <span id="formError" style="color: red"></span>
    </form>
{% endblock %}

{% block js %}
    <script src="{% static 'editor.md-1.5.0/editormd.min.js' %}"></script>
    <script>
        $(function () {
            $.ajaxSetup({
                headers: {
                    "X-CSRFToken": $("[name='csrfmiddlewaretoken']").val()
                }
            });

            var editor = editormd("editor-container", {
                width: "100%",
                height: 500,
                path: "{% static 'editor.md-1.5.0/lib/' %}",
                placeholder: "开始撰写博客内容...",
                toolbarIcons: ["table"],
                toolbar: true,
                saveHTMLToTextarea: true
            });

            $("#uploadImageBtn").on("click", function () {
                $("#imageFileInput").click();
            });

            $("#imageFileInput").on("change", function () {
                var file = this.files && this.files[0];
                if (!file) {
                    return;
                }
                var uploadData = new FormData();
                uploadData.append("editormd-image-file", file);

                $.ajax({
                    url: "{% url 'upload_article_image' %}",
                    type: "POST",
                    data: uploadData,
                    processData: false,
                    contentType: false,
                    success: function (res) {
                        if (res && res.success === 1 && res.url) {
                            var currentMd = editor.getMarkdown() || "";
                            var appendMd = "\n![](" + res.url + ")\n";
                            editor.setMarkdown(currentMd + appendMd);
                            alert("图片上传成功，已插入正文末尾");
                        } else {
                            alert((res && res.message) || "图片上传失败");
                        }
                    },
                    error: function () {
                        alert("图片上传失败，请稍后重试");
                    },
                    complete: function () {
                        $("#imageFileInput").val("");
                    }
                });
            });

            var maxTags = 3;
            $('input[name="tags"]').change(function () {
                var checked = $('input[name="tags"]:checked').length;
                if (checked > maxTags) {
                    alert('最多只能选择 ' + maxTags + ' 个标签');
                    this.checked = false;
                }
            });

            $("#submitBtn").click(function () {
                var title = $("#title").val().trim();
                var content = editor.getMarkdown().trim();
                var csrfmiddlewaretoken = $("[name='csrfmiddlewaretoken']").val();

                if (!title) {
                    alert('请输入文章标题');
                    return;
                }
                if (!content) {
                    alert('请输入文章内容');
                    return;
                }
                if ($('input[name="tags"]:checked').length === 0) {
                    alert('请至少选择一个标签');
                    return;
                }

                var formData = new FormData();
                formData.append('title', title);
                formData.append('content', content);
                formData.append('csrfmiddlewaretoken', csrfmiddlewaretoken);
                $('input[name="tags"]:checked').each(function () {
                    formData.append('tags', $(this).val());
                });

                $.ajax({
                    url: "{% url 'edit_article' article.id %}",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (res) {
                        if (res.code === 200) {
                            alert("更新成功");
                            location.href = "/article/{{ article.id }}/";
                        } else {
                            var firstError = Object.values(res.msg)[0][0];
                            $("#formError").text(firstError);
                        }
                    }
                });
            });
        });
    </script>
{% endblock %}
